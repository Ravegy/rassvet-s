<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карточка товара | РАССВЕТ-С</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="header">
        <div class="container header-main">
            <a href="index.html" class="logo-text"><h1>РАССВЕТ-С</h1></a>
            <nav class="header-nav">
                <a href="index.html" class="nav-link">В каталог</a>
                <a href="#" class="nav-link">Контакты</a>
            </nav>
            <div class="header-contacts">
                <a href="tel:+79818881337" class="header-phone" id="headerPhone">+7 (981) 888-13-37</a>
            </div>
        </div>
    </header>

    <div class="container" style="padding-top: 40px; padding-bottom: 60px; flex: 1;">
        <div id="productDetail">
            <div class="loader-container">
                <div class="spinner"></div>
                <p>Загрузка товара...</p>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container footer-grid">
            <div class="footer-col">
                <h4>РАССВЕТ-С</h4>
                <p>Профессиональные запчасти Komatsu</p>
                <p style="color: #666; font-size: 13px; margin-top: 10px;">Санкт-Петербург, ул. Промышленная, д. 42</p>
            </div>
            <div class="footer-col">
                <h4>Связь</h4>
                <a href="tel:+79818881337" class="footer-phone-big">+7 (981) 888-13-37</a>
            </div>
        </div>
    </footer>

    <script src="config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');

            if (!productId) {
                document.getElementById('productDetail').innerHTML = '<h2 style="text-align:center; color:#fff;">Товар не найден</h2><div style="text-align:center"><a href="index.html" class="btn-load-more">Вернуться в каталог</a></div>';
                return;
            }

            // Пытаемся найти товар в кэше
            const cacheKey = 'rassvet_v4_data';
            const cachedData = localStorage.getItem(cacheKey);

            if (cachedData) {
                const products = JSON.parse(cachedData);
                const product = products.find(p => p.id === productId);
                if (product) renderProduct(product);
                else loadFromNetwork(productId);
            } else {
                loadFromNetwork(productId);
            }

            function loadFromNetwork(id) {
                if(typeof SITE_CONFIG === 'undefined') return;
                fetch(SITE_CONFIG.sheetUrl)
                    .then(res => res.text())
                    .then(csvText => {
                        const rows = parseCSV(csvText);
                        rows.shift();
                        const foundRow = rows.find(r => r[0] === id);
                        
                        if (foundRow) {
                            renderProduct({
                                id: foundRow[0],
                                sku: foundRow[1],
                                name: foundRow[2],
                                price: foundRow[3],
                                category: foundRow[4],
                                image: foundRow[5],
                                desc: foundRow[6]
                            });
                        } else {
                            document.getElementById('productDetail').innerHTML = '<h2 style="text-align:center; color:#fff;">Товар не найден</h2>';
                        }
                    });
            }

            function renderProduct(p) {
                let imgUrl = SITE_CONFIG.placeholderImage;
                if (p.image && p.image.trim()) {
                    imgUrl = p.image.startsWith('http') ? p.image : `images/parts/${p.image}`;
                }
                const priceFmt = p.price ? new Intl.NumberFormat('ru-RU').format(parseFloat(p.price.replace(/\s/g,'').replace(',','.'))) + ' ₽' : 'По запросу';

                // Используем стиль product-card, но адаптированный под страницу
                const html = `
                    <div class="product-card" style="flex-direction: row; flex-wrap: wrap; gap: 40px; padding: 40px; min-height: 400px; align-items: flex-start;">
                        <div class="img-wrapper" style="flex: 1; min-width: 300px; height: 400px; border: 1px solid #eee;">
                            <img src="${imgUrl}" alt="${p.name}" class="product-img" onerror="this.src='${SITE_CONFIG.placeholderImage}'">
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div class="product-sku" style="font-size: 14px; margin-bottom: 10px;">АРТИКУЛ: ${p.sku}</div>
                            <h1 style="font-size: 28px; font-weight: 800; margin: 0 0 20px; color: #111;">${p.name}</h1>
                            <div class="product-price" style="font-size: 32px; margin-bottom: 30px;">${priceFmt}</div>
                            
                            <div class="btn-group" style="margin-bottom: 30px; max-width: 300px;">
                                <a href="https://wa.me/${SITE_CONFIG.phone}?text=Здравствуйте! Интересует ${p.sku} ${p.name}" target="_blank" class="btn-card btn-green" style="padding: 15px;">Заказать в WhatsApp</a>
                            </div>

                            <div style="font-size: 16px; line-height: 1.6; color: #555; border-top: 1px solid #eee; padding-top: 20px;">
                                <strong>Описание:</strong><br>
                                ${p.desc || 'Описание отсутствует.'}
                                <br><br>
                                <strong>Категория:</strong> ${p.category || '-'}
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('productDetail').innerHTML = html;
            }

            function parseCSV(text) {
                const result = []; let row = []; let inQuote = false; let cell = '';
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (char === '"') inQuote = !inQuote;
                    else if (char === ',' && !inQuote) { row.push(cell); cell = ''; }
                    else if ((char === '\r' || char === '\n') && !inQuote) {
                        if (cell || row.length > 0) row.push(cell);
                        if (row.length > 0) result.push(row);
                        row = []; cell = ''; if (char === '\r' && text[i+1] === '\n') i++;
                    } else cell += char;
                }
                if (cell || row.length > 0) { row.push(cell); result.push(row); }
                return result;
            }
        });
    </script>
</body>
</html>
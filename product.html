<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карточка товара | РАССВЕТ-С</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="header">
        <div class="container header-main">
            <a href="index.html" class="logo-text"><h1>РАССВЕТ-С</h1></a>
            <nav class="header-nav">
                <a href="index.html" class="nav-link">В каталог</a>
                <a href="#" class="nav-link">Контакты</a>
            </nav>
            <div class="header-contacts">
                <a href="tel:+79818881337" class="header-phone" id="headerPhone">+7 (981) 888-13-37</a>
                <div id="cartWidget" class="cart-widget">Корзина: 0</div>
            </div>
        </div>
    </header>

    <div class="container" style="padding-top: 60px; padding-bottom: 80px; flex: 1;">
        <div id="productDetail">
            <div class="loader-container">
                <div class="spinner"></div>
                <p>Загрузка товара...</p>
            </div>
        </div>
    </div>

    <div id="cartModal" class="cart-modal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Ваша корзина</h2>
                <span class="close-cart" id="closeCart">&times;</span>
            </div>
            <div class="cart-items" id="cartItems"></div>
            <div class="cart-footer">
                <span id="cartTotal" class="cart-total">Итого: 0 ₽</span>
                <button id="cartOrderBtn" class="btn-cart-order">Отправить запрос</button>
            </div>
        </div>
    </div>

    <div id="orderModal" class="cart-modal" style="z-index: 2100;">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Оформление заказа</h2>
                <span class="close-cart" id="closeOrder">&times;</span>
            </div>
            <form id="orderForm" class="order-form">
                <div class="form-group">
                    <input type="text" id="orderName" class="form-input" placeholder="Ваше Имя" required>
                </div>
                <div class="form-group">
                    <input type="tel" id="orderPhone" class="form-input" placeholder="Номер телефона" required>
                </div>
                <div class="form-group">
                    <input type="email" id="orderEmail" class="form-input" placeholder="Email (необязательно)">
                </div>
                <button type="submit" class="btn-cart-order">Подтвердить заказ</button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <div class="container footer-grid">
            <div class="footer-col">
                <h4>РАССВЕТ-С</h4>
                <p>Профессиональные запчасти Komatsu</p>
                <p style="color: #666; font-size: 13px; margin-top: 10px;">Санкт-Петербург, ул. Промышленная, д. 42</p>
            </div>
            <div class="footer-col">
                <h4>Связь</h4>
                <a href="tel:+79818881337" class="footer-phone-big">+7 (981) 888-13-37</a>
            </div>
        </div>
    </footer>

    <div id="toast-container"></div>

    <script src="config.js"></script>
    <script src="app.js"></script> 
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');

            if (!productId) {
                document.getElementById('productDetail').innerHTML = `
                    <h2 style="text-align:center; color:#fff; margin-bottom:30px;">Товар не найден</h2>
                    <div style="text-align:center">
                        <a href="index.html" class="btn-load-more">Вернуться в каталог</a>
                    </div>`;
                return;
            }

            const cacheKey = 'rassvet_v7_data';
            const cachedData = localStorage.getItem(cacheKey);

            if (cachedData) {
                const products = JSON.parse(cachedData);
                const product = products.find(p => p.id === productId);
                if (product) renderProduct(product);
                else loadFromNetwork(productId);
            } else {
                loadFromNetwork(productId);
            }

            function loadFromNetwork(id) {
                if(typeof SITE_CONFIG === 'undefined') return;
                fetch(SITE_CONFIG.sheetUrl)
                    .then(res => res.text())
                    .then(csvText => {
                        const rows = parseCSV(csvText);
                        rows.shift();
                        const foundRow = rows.find(r => r[0] === id);
                        if (foundRow) {
                            renderProduct({
                                id: foundRow[0], sku: foundRow[1], name: foundRow[2],
                                price: foundRow[3], category: foundRow[4], image: foundRow[5], desc: foundRow[6]
                            });
                        } else {
                             document.getElementById('productDetail').innerHTML = `
                                <h2 style="text-align:center; color:#fff; margin-bottom:30px;">Товар не найден</h2>
                                <div style="text-align:center">
                                    <a href="index.html" class="btn-load-more">Вернуться в каталог</a>
                                </div>`;
                        }
                    });
            }

            function renderProduct(p) {
                let imgUrl = SITE_CONFIG.placeholderImage;
                if (p.image && p.image.trim()) {
                    imgUrl = p.image.startsWith('http') ? p.image : `images/parts/${p.image}`;
                }
                const priceFmt = p.price ? new Intl.NumberFormat('ru-RU').format(parseFloat(p.price.replace(/\s/g,'').replace(',','.'))) + ' ₽' : 'По запросу';
                const nameClean = p.name.replace(/'/g, "");

                const html = `
                    <div class="product-full-card" data-product-id="${p.id}">
                        <div class="full-img-wrapper">
                            <img src="${imgUrl}" alt="${p.name}" onerror="this.src='${SITE_CONFIG.placeholderImage}'">
                        </div>
                        <div class="full-info">
                            <div class="full-sku">АРТИКУЛ: ${p.sku}</div>
                            <h1 class="full-title">${p.name}</h1>
                            <div class="full-price">${priceFmt}</div>
                            <div class="full-actions-group">
                                <a href="index.html" class="btn-detail blue">В КАТАЛОГ</a>
                                <button id="btn-add-${p.id}" onclick="addToCart('${p.id}', '${p.sku}', '${nameClean}', '${priceFmt}')" class="btn-detail green">В КОРЗИНУ</button>
                                <div id="btn-qty-${p.id}" class="btn-qty-grid hidden">
                                    <button onclick="updateItemQty('${p.id}', -1)">-</button>
                                    <span id="qty-val-${p.id}">1</span>
                                    <button onclick="updateItemQty('${p.id}', 1)">+</button>
                                </div>
                            </div>
                            <div class="full-desc">
                                <strong>Описание:</strong><br>${p.desc || 'Описание отсутствует.'}<br><br>
                                <strong>Категория:</strong> ${p.category || '-'}
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('productDetail').innerHTML = html;
                // Функция из app.js, которая проверит корзину и обновит кнопки
                if(typeof syncButtonsWithCart === 'function') syncButtonsWithCart();
            }

            function parseCSV(text) {
                const result = []; let row = []; let inQuote = false; let cell = '';
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (char === '"') inQuote = !inQuote;
                    else if (char === ',' && !inQuote) { row.push(cell); cell = ''; }
                    else if ((char === '\r' || char === '\n') && !inQuote) {
                        if (cell || row.length > 0) row.push(cell);
                        if (row.length > 0) result.push(row);
                        row = []; cell = ''; if (char === '\r' && text[i+1] === '\n') i++;
                    } else cell += char;
                }
                if (cell || row.length > 0) { row.push(cell); result.push(row); }
                return result;
            }
        });
    </script>
</body>
</html>
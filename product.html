<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карточка товара | РАССВЕТ-С</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="header">
        <div class="container header-main">
            <a href="index.html" class="logo-text"><h1>РАССВЕТ-С</h1></a>
            <nav class="header-nav">
                <a href="index.html" class="nav-link">В каталог</a>
                <a href="#" class="nav-link">Контакты</a>
            </nav>
            <div class="header-contacts">
                <a href="tel:+79818881337" class="header-phone" id="headerPhone">+7 (981) 888-13-37</a>
                <div id="cartWidget" class="cart-widget">Корзина: 0</div>
            </div>
        </div>
    </header>

    <div class="container" style="padding-top: 60px; padding-bottom: 80px; flex: 1;">
        <div id="productDetail">
            <div class="loader-container">
                <div class="spinner"></div>
                <p>Загрузка товара...</p>
            </div>
        </div>
    </div>

    <div id="cartModal" class="cart-modal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>Ваша корзина</h2>
                <span class="close-cart" id="closeCart">&times;</span>
            </div>
            <div class="cart-items" id="cartItems"></div>
            <div class="cart-footer">
                <span id="cartTotal" class="cart-total">Итого: 0 ₽</span>
                <a href="#" id="cartOrderBtn" class="btn-cart-order" target="_blank">Оформить в WhatsApp</a>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container footer-grid">
            <div class="footer-col">
                <h4>РАССВЕТ-С</h4>
                <p>Профессиональные запчасти Komatsu</p>
                <p style="color: #666; font-size: 13px; margin-top: 10px;">Санкт-Петербург, ул. Промышленная, д. 42</p>
            </div>
            <div class="footer-col">
                <h4>Связь</h4>
                <a href="tel:+79818881337" class="footer-phone-big">+7 (981) 888-13-37</a>
            </div>
        </div>
    </footer>

    <div id="toast-container"></div>

    <script src="config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- УВЕДОМЛЕНИЯ ---
            function showNotification(message) {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('hiding');
                    toast.addEventListener('animationend', () => { toast.remove(); });
                }, 3000);
            }

            // --- ЛОГИКА КОРЗИНЫ ---
            let cart = JSON.parse(localStorage.getItem('rassvet_cart')) || [];
            
            function updateCartUI() {
                const widget = document.getElementById('cartWidget');
                const cartItems = document.getElementById('cartItems');
                const cartTotal = document.getElementById('cartTotal');
                const orderBtn = document.getElementById('cartOrderBtn');
                
                // Виджет
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                if(widget) widget.textContent = `Корзина: ${totalItems}`;
                
                if(cartItems) {
                    cartItems.innerHTML = '';
                    let total = 0;
                    cart.forEach((item, index) => {
                        const priceNum = parseFloat(item.price.replace(/\s/g, '').replace('₽','').replace(',', '.')) || 0;
                        total += priceNum * item.quantity;
                        
                        const div = document.createElement('div');
                        div.className = 'cart-item';
                        div.innerHTML = `
                            <div class="cart-item-info">
                                <span class="cart-item-title">${item.sku} - ${item.name}</span>
                                <span class="cart-item-price">${item.price}</span>
                            </div>
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="changeQuantityModal(${index}, -1)">-</button>
                                <span class="qty-count">${item.quantity}</span>
                                <button class="qty-btn" onclick="changeQuantityModal(${index}, 1)">+</button>
                            </div>
                            <button class="btn-remove" onclick="removeCartItem(${index})">&times;</button>
                        `;
                        cartItems.appendChild(div);
                    });
                    
                    if(cartTotal) cartTotal.textContent = `Итого: ${new Intl.NumberFormat('ru-RU').format(total)} ₽`;
                    
                    if(orderBtn) {
                        let msg = "Здравствуйте! Хочу оформить заказ:%0A";
                        cart.forEach(item => {
                            msg += `- ${item.sku} ${item.name} — ${item.quantity} шт. (${item.price})%0A`;
                        });
                        msg += `%0AИтого: ${new Intl.NumberFormat('ru-RU').format(total)} ₽`;
                        orderBtn.href = `https://wa.me/${SITE_CONFIG.phone}?text=${msg}`;
                    }
                }
                localStorage.setItem('rassvet_cart', JSON.stringify(cart));
                syncButtonsWithCart();
            }

            function syncButtonsWithCart() {
                // Ищем контейнер товара на странице
                const productCard = document.querySelector('[data-product-id]');
                if (!productCard) return;

                const id = productCard.getAttribute('data-product-id');
                const cartItem = cart.find(item => item.id === id);
                
                const btnAdd = document.getElementById(`btn-add-${id}`);
                const btnQty = document.getElementById(`btn-qty-${id}`);
                const countSpan = document.getElementById(`qty-val-${id}`);

                if (btnAdd && btnQty && countSpan) {
                    if (cartItem) {
                        btnAdd.classList.add('hidden');
                        btnQty.classList.remove('hidden');
                        countSpan.textContent = cartItem.quantity;
                    } else {
                        btnAdd.classList.remove('hidden');
                        btnQty.classList.add('hidden');
                    }
                }
            }

            const modal = document.getElementById('cartModal');
            const widget = document.getElementById('cartWidget');
            const close = document.getElementById('closeCart');
            
            if(widget) widget.onclick = () => { modal.style.display = 'flex'; updateCartUI(); };
            if(close) close.onclick = () => { modal.style.display = 'none'; };
            window.onclick = (e) => { if(e.target == modal) modal.style.display = 'none'; };

            // Глобальные функции
            window.addToCart = (id, sku, name, price) => {
                const existingItem = cart.find(item => item.id === id);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({id, sku, name, price, quantity: 1});
                    showNotification('Товар добавлен в корзину');
                }
                updateCartUI();
                const widgetBtn = document.getElementById('cartWidget');
                if(widgetBtn) {
                     widgetBtn.style.transform = "scale(1.2)";
                     setTimeout(() => widgetBtn.style.transform = "scale(1)", 200);
                }
            };

            window.updateItemQty = (id, delta) => {
                const item = cart.find(p => p.id === id);
                if (item) {
                    item.quantity += delta;
                    if (item.quantity <= 0) {
                        cart = cart.filter(p => p.id !== id);
                    }
                    updateCartUI();
                }
            };

            window.changeQuantityModal = (index, delta) => {
                const item = cart[index];
                item.quantity += delta;
                if (item.quantity <= 0) item.quantity = 1; 
                updateCartUI();
            };

            window.removeCartItem = (index) => {
                cart.splice(index, 1);
                updateCartUI();
            };

            updateCartUI(); 

            // --- ЗАГРУЗКА ДАННЫХ ТОВАРА ---
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');

            if (!productId) {
                document.getElementById('productDetail').innerHTML = `
                    <h2 style="text-align:center; color:#fff; margin-bottom:30px;">Товар не найден</h2>
                    <div style="text-align:center">
                        <a href="index.html" class="btn-load-more">Вернуться в каталог</a>
                    </div>`;
                return;
            }

            const cacheKey = 'rassvet_v7_data';
            const cachedData = localStorage.getItem(cacheKey);

            if (cachedData) {
                const products = JSON.parse(cachedData);
                const product = products.find(p => p.id === productId);
                if (product) renderProduct(product);
                else loadFromNetwork(productId);
            } else {
                loadFromNetwork(productId);
            }

            function loadFromNetwork(id) {
                if(typeof SITE_CONFIG === 'undefined') return;
                fetch(SITE_CONFIG.sheetUrl)
                    .then(res => res.text())
                    .then(csvText => {
                        const rows = parseCSV(csvText);
                        rows.shift();
                        const foundRow = rows.find(r => r[0] === id);
                        
                        if (foundRow) {
                            renderProduct({
                                id: foundRow[0],
                                sku: foundRow[1],
                                name: foundRow[2],
                                price: foundRow[3],
                                category: foundRow[4],
                                image: foundRow[5],
                                desc: foundRow[6]
                            });
                        } else {
                             document.getElementById('productDetail').innerHTML = `
                                <h2 style="text-align:center; color:#fff; margin-bottom:30px;">Товар не найден</h2>
                                <div style="text-align:center">
                                    <a href="index.html" class="btn-load-more">Вернуться в каталог</a>
                                </div>`;
                        }
                    });
            }

            function renderProduct(p) {
                let imgUrl = SITE_CONFIG.placeholderImage;
                if (p.image && p.image.trim()) {
                    imgUrl = p.image.startsWith('http') ? p.image : `images/parts/${p.image}`;
                }
                const priceFmt = p.price ? new Intl.NumberFormat('ru-RU').format(parseFloat(p.price.replace(/\s/g,'').replace(',','.'))) + ' ₽' : 'По запросу';
                const nameClean = p.name.replace(/'/g, "");

                const html = `
                    <div class="product-full-card" data-product-id="${p.id}">
                        <div class="full-img-wrapper">
                            <img src="${imgUrl}" alt="${p.name}" onerror="this.src='${SITE_CONFIG.placeholderImage}'">
                        </div>
                        
                        <div class="full-info">
                            <div class="full-sku">АРТИКУЛ: ${p.sku}</div>
                            <h1 class="full-title">${p.name}</h1>
                            <div class="full-price">${priceFmt}</div>
                            
                            <div class="full-actions-group">
                                <a href="index.html" class="btn-detail blue">В КАТАЛОГ</a>
                                
                                <button id="btn-add-${p.id}" 
                                        onclick="addToCart('${p.id}', '${p.sku}', '${nameClean}', '${priceFmt}')" 
                                        class="btn-detail green">
                                    В КОРЗИНУ
                                </button>

                                <div id="btn-qty-${p.id}" class="btn-qty-grid hidden">
                                    <button onclick="updateItemQty('${p.id}', -1)">-</button>
                                    <span id="qty-val-${p.id}">1</span>
                                    <button onclick="updateItemQty('${p.id}', 1)">+</button>
                                </div>
                            </div>

                            <div class="full-desc">
                                <strong>Описание:</strong><br>
                                ${p.desc || 'Описание отсутствует.'}
                                <br><br>
                                <strong>Категория:</strong> ${p.category || '-'}
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('productDetail').innerHTML = html;
                syncButtonsWithCart(); // Сразу проверяем, в корзине ли товар
            }

            function parseCSV(text) {
                const result = []; let row = []; let inQuote = false; let cell = '';
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (char === '"') inQuote = !inQuote;
                    else if (char === ',' && !inQuote) { row.push(cell); cell = ''; }
                    else if ((char === '\r' || char === '\n') && !inQuote) {
                        if (cell || row.length > 0) row.push(cell);
                        if (row.length > 0) result.push(row);
                        row = []; cell = ''; if (char === '\r' && text[i+1] === '\n') i++;
                    } else cell += char;
                }
                if (cell || row.length > 0) { row.push(cell); result.push(row); }
                return result;
            }
        });
    </script>
</body>
</html>